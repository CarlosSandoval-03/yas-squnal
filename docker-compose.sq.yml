services:
  sq-db:
    image: mysql:8.0
    environment:
      MYSQL_ROOT_PASSWORD: password
      MYSQL_DATABASE: tasks_db
    ports:
      - "3306:3306"
    volumes:
      - sq-db-data:/var/lib/mysql
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 10s
      timeout: 5s
      retries: 5

  sq-be:
    build: ./sq-be
    ports:
      - "5000:5000"
    environment:
      DB_HOST: sq-db
      DB_NAME: tasks_db
      DB_USER: root
      DB_PASSWORD: password
    depends_on:
      sq-db:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/health"]
      interval: 10s
      timeout: 5s
      retries: 5

  sq-fe:
    build: ./sq-fe
    ports:
      - "3000:3000"
    environment:
      REACT_APP_API_BASE: http://localhost:5000
    depends_on:
      - sq-be
    stdin_open: true
    tty: true

  # Integration test services
  sq-be-int-tests:
    build: ./sq-be
    command: ["sh", "-c", "sleep 5 && API_BASE_URL=http://sq-be:5000 pytest tests_integration -v"]
    environment:
      DB_HOST: sq-db
      DB_NAME: tasks_db
      DB_USER: root
      DB_PASSWORD: password
      API_BASE_URL: http://sq-be:5000
    depends_on:
      sq-db:
        condition: service_healthy
      sq-be:
        condition: service_healthy
    networks:
      - default

  sq-fe-int-tests:
    build: ./sq-fe
    command: ["sh", "-c", "sleep 10 && npm test -- src/__tests__/integration.test.js --watchAll=false --ci"]
    environment:
      REACT_APP_API_BASE: http://sq-be:5000
      CI: true
    depends_on:
      sq-be:
        condition: service_healthy
    networks:
      - default

volumes:
  sq-db-data:

